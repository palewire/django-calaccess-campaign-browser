{% extends 'calaccess_campaign_browser/base.html' %}
{% load humanize %}

{% block title %}{{ committee }} - Committee - {{ block.super }}{% endblock %}

{% block content %}

{% include "calaccess_campaign_browser/committee_nav.html" %}


<div class="row">
  <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
    <p><strong>Status:</strong> {{ committee.get_status_display }}</p>
    <p><strong>Effective Date:</strong> {{ committee.effective_date|date:"Y-m-d" }}</p>
  </div>
  <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
    <p><strong>Type:</strong> {{ committee.get_committee_type_display }}</p>
    <p><strong>Party:</strong> {{ committee.get_party_display }}</p>
  </div>
  <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
    <p><strong>ID:</strong> {{ committee.filer_id_raw }}</p>
    <p><strong>Source:</strong> <a target="_blank" href="{{ committee.get_calaccess_url }}">Cal-Access</a></p>
  </div>
</div>

<div class="row">        
    <h3>Cashflow</h3>     
    <div class="col-lg-6 col-md-6 col-sm-8 col-xs-12">

        <table class="table table-bordered table-hover">
        <tbody>
          <tr>
              <td>Total Contributions</td>
              <td class="right">${{ committee.total_contributions|default_if_none:0|floatformat:0|intcomma }}</td>
          </tr>
          <tr>
              <td>Total Expenditures</td>
              <td class="right">${{ committee.total_expenditures|default_if_none:0|floatformat:0|intcomma }}</td>
          </tr>
          <tr>
              <td>Balance</td>
              <td class="right totals">${{ committee.total_cashflow_balance|default_if_none:0|floatformat:0|intcomma }}</td>
          </tr>
        </tbody>
        </table>
    </div>     
</div>
<div class="row">
    <div class="graphheader">
      <h4> Contributions and expenditure by year</h4>      
      <a class="toggle-btn" data-toggle="collapse" href="#cashflowData" aria-expanded="false" aria-controls="cashflowData">
            Show/hide data
      </a>
    </div>

    <div id="cashflowData" class="collapse row">
      <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
        {% if committee.total_contributions_by_year %}
        <h4>Contributions by year</h4>
        <table class="table table-bordered table-hover">
        <thead>
            <tr>
                <th data-sort="int">Year</th>
                <th  data-sort="currency" class="right">Total</th>
            </tr>
        </thead>
        <tbody>
            {% for year, total in committee.total_contributions_by_year %}
                <tr>
                    <td>{{ year }}</td>
                    <td class="right">${{ total|floatformat:0|intcomma }}</td>
                </tr>
            {% endfor %}
        </tbody>
        </table>
        {% endif %}
      </div>
      <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
          {% if committee.total_expenditures_by_year %}
          <h4>Expenditures by year</h4>
          <table class="table table-bordered table-hover">
          <thead>
              <tr>
                  <th data-sort="int">Year</th>
                  <th  data-sort="currency" class="right">Total</th>
              </tr>
          </thead>
          <tbody>
              {% for year, total in committee.total_expenditures_by_year %}
                  <tr>
                      <td>{{ year }}</td>
                      <td class="right">${{ total|floatformat:0|intcomma }}</td>
                  </tr>
              {% endfor %}
          </tbody>
          </table>
          {% endif %}
      </div>
    </div>
    <div id="moneyFlowViz" class="col-lg-12 col-md-12 col-sm-12 col-xs-12">    
    </div>
    <ul class="legend right col-lg-6 col-md-6 col-sm-12 col-xs-12">
        <li class="legenditem"><span class="series1"></span>Contribution</li>
        <li class="legenditem"><span class="series2"></span>Expenditure</li>
    </ul> 
</div>

{% if filing_set_count %}
<div class="row">
  <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
    <h3>
          <a href="{% url 'committee_filing_list' committee.pk 1 %}">Filings</a>
          <div class="btn-group">
              <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                Download data <span class="caret"></span>
              </button>
              <ul class="dropdown-menu" role="menu">
                <li><a href="{% url 'committee_filing_list' committee.pk 1 %}?format=csv">Download CSV</a></li>
                <li><a href="{% url 'committee_filing_list' committee.pk 1 %}?format=json">Download JSON</a></li>
              </ul>
          </div>
    </h3>
    <p>{% if filing_set_count > 25 %}(Most recent 25){% endif %}</p>
  </div>
</div>
<div class="testviz">
<div class="row">
  <div class="span12" id="dc-time-chart">
    <h4>Filings by Time</h4>
  </div>
  <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
    <table class="table table-hover" id="dc-table-graph">
      <thead>
        <tr class="header">
          <th>No.</th>
          <th>Filed</th>
          <th>Form</th>
          <th>Period</th>
          <th>Contributions</th>
          <th>Expenditures</th>
          <th>Debts</th>
          <th>PDF</th>
        </tr>
      </thead>
    </table>
</div>
</div>
<!-- <div class="row">
  <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
      <table class="table table-bordered table-hover searchable-list">
        <thead>
            <tr>
                <th data-sort="int">No.</th>
                <th data-sort="date">Filed</th>
                <th>Form</th>
                <th>Period</th>
                <th data-sort="currency" class="right">Contributions</th>
                <th data-sort="currency" class="right">Expenditures</th>
                <th data-sort="currency" class="right">Debts</th>
                <th class="center">PDF</th>
            </tr>
        </thead>
        <tbody>
        {% for filing in filing_set_short %}
          <tr>
            <td>
              <a href="{{ filing.get_absolute_url }}">{{ filing.filing_id_raw }}</a>
            </td>
            <td>{{ filing.date_filed|date:"Y-m-d" }}</td>
            <td>{{ filing.get_form_type_display }}</td>
            <td>{{ filing.start_date|date:"Y-m-d" }} - {{ filing.end_date|date:"Y-m-d" }}</td>
            <td class="right">
                ${{ filing.total_contributions|default_if_none:0|floatformat:0|intcomma }}
            </td>
            <td class="right">
                ${{ filing.total_expenditures|default_if_none:0|floatformat:0|intcomma }}
            </td>
            <td class="right">
                {% if filing.summary.outstanding_debts != None %}
                ${{ filing.summary.outstanding_debts|default_if_none:0|floatformat:0|intcomma }}
                {% endif %}
            </td>
            <td class="center">
                <a target="_blank" href="{{ filing.get_calaccess_pdf_url }}">
                    <i class="fa fa-file-pdf-o"></i>
                </a>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% if filing_set_count > 25 %}
        <p class="view-more"><a href="{% url 'committee_filing_list' committee.pk 1 %}">View more... </a></p>
    {% endif %}
  </div>
</div>
{% endif %} -->

{% if contribs_set_short %}
<div class="row">
    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <h3>
              <a href="{% url 'committee_contribution_list' committee.pk 1 %}">Contributions received</a>
              <div class="btn-group">
                  <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                    Download data <span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu" role="menu">
                    <li><a href="{% url 'committee_contribution_list' committee.pk 1 %}?format=csv">Download CSV</a></li>
                    <li><a href="{% url 'committee_contribution_list' committee.pk 1 %}?format=json">Download JSON</a></li>
                  </ul>
              </div>
        </h3>
        <p>Top 25 contributions by amount</p>
        <table class="table table-bordered table-hover searchable-list">
          <thead>
            <tr>
                <th data-sort="date">Date</th>
                <th data-sort="string">Name</th>
                <th data-sort="currency" class="right">Amount</th>
            </tr>
          </thead>
          <tbody>
              {% for contribution in contribs_set_short %}
                <tr>
                    <td>{{ contribution.date_received|date:"Y-m-d" }}</td>
                    <td>
                        {% if contribution.contributor_committee_id %}
                            <a href="{{ contribution.contributor_committee.get_absolute_url }}">
                        {% endif %}
                                {{ contribution.contributor_full_name }}
                        {% if contribution.contributor_committee_id %}
                            </a>
                        {% endif %}
                    </td>
                    <td class="right">
                        <a href="{{ contribution.get_absolute_url }}">
                            ${{ contribution.amount|floatformat:0|intcomma }}
                        </a>
                    </td>
                </tr>
              {% endfor %}
          </tbody>
        </table>
          {% if contribs_set_count > 25 %}
            <p class="view-more"><a href="{% url 'committee_contribution_list' committee.pk 1 %}">View more... </a></p>
          {% endif %}
    </div>
</div>
{% endif %}

{% if contribs_out_list %}
<div class="row">
    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <h3>Contributions made</h3>
        <p>Top 25 by amount</p>
        <table class="table table-bordered table-hover searchable-list">
          <thead>
            <tr>
                <th data-sort="date">Date</th>
                <th data-sort="string">Name</th>
                <th data-sort="currency" class="right">Amount</th>
            </tr>
          </thead>
          <tbody>
              {% for obj in contribs_out_list %}
                <tr>
                    <td>{{ obj.date_received|date:"Y-m-d" }}</td>
                    <td>
                    <a href="{{ obj.committee.get_absolute_url }}">
                        {{ obj.committee.short_name }}
                    </a>
                    </td>
                    <td class="right">
                        <a href="{{ obj.get_absolute_url }}">
                            ${{ obj.amount|floatformat:0|intcomma }}
                        </a>
                    </td>
                </tr>
              {% endfor %}
          </tbody>
        </table>
    </div>
</div>
{% endif %}

{% if expenditure_set_short %}
<div class="row">
<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
  <h3>
        <a href="{% url 'committee_expenditure_list' committee.pk 1 %}">Expenditures </a>
        <div class="btn-group">
            <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
              Download data <span class="caret"></span>
            </button>
            <ul class="dropdown-menu" role="menu">
              <li><a href="{% url 'committee_expenditure_list' committee.pk 1 %}?format=csv">Download CSV</a></li>
              <li><a href="{% url 'committee_expenditure_list' committee.pk 1 %}?format=json">Download JSON</a></li>
            </ul>
        </div>
  </h3>
  <p>Top 25 expenditures by amount</p>
    <div class="table-responsive">
      <table class="table table-bordered table-hover searchable-list"> <!-- table table-bordered table-hover -->
        <thead>
          <tr>
                <th data-sort="date">Date</th>
                <th data-sort="string">Name</th>
                <th>Type</th>
                <th data-sort="currency" class="right">Amount</th>
          </tr>
        </thead>
        <tbody>
            {% for expenditure in expenditure_set_short %}
              <tr>
                  <td>{{ expenditure.expn_date|date:"Y-m-d" }}</td>
                  <td>{{ expenditure.name }}</td>
                  <td>{{ expenditure.get_expn_code_display|capfirst }}</td>
                  <td class="right">${{ expenditure.amount|intcomma }}</td>
              </tr>
            {% endfor %}
        </tbody>
      </table>
    </div>
    {% if expenditure_set_count > 25 %}
        <p class="view-more"><a href="{% url 'committee_expenditure_list' committee.pk 1 %}">View more... </a></p>
    {% endif %}
</div>
</div>
{% endif %}

{% endblock %}

{% block javascript %}
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="../../static/calaccess_campaign_browser/js/crossfilter.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/dc/1.7.0/dc.js"></script>
<link rel="stylesheet" type="text/css" href="http://cdnjs.cloudflare.com/ajax/libs/dc/1.7.0/dc.css
">
<script>
  var committee          = {{ committee_json }};
  committee.filings       = {{ filing_set_json }};
  committee.expenditures  = {{ expenditure_set_json }};
  committee.expenditures_by_year = {{ expenditure_by_year|safe }};
  committee.contributions = {{ contribs_set_json }};
  committee.contributions_by_year = {{contribs_by_year|safe }};

  committee.contributionsMade = {{ filing_set_json }};

  var dataTable = dc.dataTable("#dc-table-graph");
  var timeChart = dc.barChart("#dc-time-chart");

  var data = committee.filings;
  var parseDate = d3.time.format("%Y-%m-%d").parse;

  data.forEach(function(d){
    d.num = d.filing_id_raw;
    d.dtg = d.date_filed;
    d.date = parseDate(d.date_filed);
    d.ft = d.form_type;
    d.pd = d.start_date + " - " + d.end_date;
    d.contributions = d.summary.total_contributions;
    d.expenditures = d.summary.total_expenditures;
    d.debts = d.summary.outstanding_debts;
    console.log(d.contributions);
  });

  var info = crossfilter(data);
  var timeDimension = info.dimension(function(d){
    return d.date;
  });
  var minDate = timeDimension.bottom(1)[0].date;
  var maxDate = timeDimension.top(1)[0].date;
  var contrValueGroupCount = timeDimension.group()
      .reduceSum(function(d) { return d.contributions; });

  


timeChart.width(880)
.height(150)
.margins({top: 10, right: 10, bottom: 20, left: 50})
.dimension(timeDimension)
.group(contrValueGroupCount)
.transitionDuration(500)
.centerBar(true)
.gap(10)
.x(d3.time.scale().domain([minDate,maxDate]))
.elasticY(true)
.xAxis().tickFormat();



  dataTable.dimension(timeDimension)
            .group(function(d){return "Chart"})
            .size(13)
            .columns([
              function(d){ return d.num; },
              function(d){ return d.dtg; },
              function(d){ return d.ft; },
              function(d){ return d.pd; },
              function(d){ return d.contributions; },
              function(d){ return d.expenditures; },
              function(d){ return d.debts; },
              ])
            .sortBy(function(d){ return d.dtg; })
            .order(d3.ascending);

  dc.renderAll();

</script>

<script>
  jQuery(document).ready(function($) {
    $('.searchable-list').sieve();    
  });
</script>
{% endblock %}
